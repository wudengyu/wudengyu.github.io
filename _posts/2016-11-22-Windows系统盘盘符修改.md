---
layout: post
title:  "Windows系统盘盘符修改"
date:   2016-11-22 09:15:11 +0800
categories: jekyll update
---
克隆系统分区（为了将系统从一个硬盘搬到另一个硬盘，比如迁移到SSD，或者仅仅是想调整一下分区在磁盘上的位置），或者是挂载了新的硬盘，这时候默认的盘符顺序有可能会被打乱，系统无法引导。仅仅是不能引导的话，编辑BCD或者使用引导修复工具是很容易修复的。但是在分区物理顺序错乱的情况下，引导修复以后往往也不能正常启动，因为这时系统盘的盘符变了，而各种环境变量，比如用户 配置、PATH等还是使用原来的盘符，自然找不到原来的文件，可执行文件、DLl文件这些都不在正确的位置上了，所以系统基本上没办法运行。用户配置就算可以删除重建、系统配置没有办法重建，除非重装系统。所以，最简单的办法就是把系统盘盘符更正过来。

在WINDOWS中，盘符似乎是记录在系统某个地方的，并不像DOS那样完全是按物理顺序。因为磁盘管理工具可以修改盘符（修改不了系统所在盘，因为修改盘符的时候需要卸载文件系统），修改了盘符重启动修改仍然是生效的，也就是说，在windows中，盘符是相对固定的。如果把系统盘克隆到另一个分区，这时候引导原来的系统当然不会有问题，如果通过修改BCD来引导新的系统分区，会出现什么情况呢？如果克隆是在旧系统里面做的，那么实际上新系统所在分区在旧系统里面已经分配得有一个盘符，并且一定不会是C盘，克隆的系统里面包含有这个信息，这时如果旧系统分区还在，那么是可以进入克隆出来的系统的，这个时候，相当于引导是新系统，但是读取和配置有关的文件、用户配置、系统文件实际上是从原来的系统盘C盘读取的，因为原来的东西都在对应的位置上，所以系统可以工作。但如果把原来的系统盘删掉，就不能正常启动了。如果克隆是在PE下做的，那就要看修改BCD后，新系统盘的物理顺序了。同样，如果原来的系统分区还在，并且由于克隆的系统里面包含了旧系统的盘符是C的信息，这时候不管新系统分配到的盘符是什么，系统还是可以运行，和前面的情况一样，都是新系统引导，但是是到旧系统上读取文件，同样，再删除旧系统分区之后，就不能正常启动。如果在PE下克隆系统分区，并且克隆成功后删除旧的系统分区。这样的话，引导修复之后，系统会发现一个新的磁盘，并且由于原来的C盘已经不存在了，所以，就会把C盘盘符分配给这个新的分区，结果是新系统可以正常启动和运行。这只是建一个分区、同时删除一个分区的情况，如果建的分区比较多，那就要看新的系统分区所在的物理顺序了，如果仍然是新分出来的区的第一个，那么仍然没有问题，如果不是，那肯定不能启动。

出现这种问题，怎么修复盘符。网上好多地方说用磁盘管理器，系统都不能启动，怎么用磁盘管理器。再说磁盘管理器又不能修改系统盘盘符。而在PE下使用磁盘管理器修改盘符，那只是PE下的磁盘盘符，并不是硬盘上的系统上的盘符。所以必须修改保存在原来系统盘中的盘符信息。查询到Windows的盘符信息是保存在注册表HKLM\SYSTEM\MountedDevices下的，里面有\DosDevices\C:这样的键，就是盘符对应的分区信息。那么如何修改呢？PE下的注册表编辑器修改的仍然是PE系统的注册表呀。其实注册表编辑器是可以挂载注册表文件的，将光标定位在HKEY_LOCAL_MACHINE上，文件菜单或右键菜单上就可以有“加载配置单元”，选择要修改的系统的%SYSDIR%/config/下的SYSTEM文件，然后再输入一个挂载点名称就可以挂载了。接下来就可以修改其下的MountedDevices\DosDevices\C:的值了。内容可以从PE下的HKLM\SYSTEM\MountedDevices中对应的磁盘名称的值复制过来，这个值有的长有的短，但是不用管它，反正是用来标识唯一分区的，反正在硬盘不变，分区不变的情况下，PE下得到的值和硬盘系统得到的值是一样的，直接复制就可以了。这里主要修改系统盘就行了，只要系统能启动，修改其他盘用不着这样，用磁盘管理器又简单，又方便。